import malw2img, sys
import os
import numpy,scipy, os, array, scipy.misc
from PIL import Image

width = 256

if (sys.argv[1] == 'help'):
    print('Converts all executables into images in given folder with width = 256\nUsage: $python3 malw2img.py [folder name] [destination folder name]\n  OR $python3 malw2img.py [file name]')
elif (len(sys.argv) <= 1):
    print('Invalid # of arguments. For more info, type $python3 malw2img.py help')
else:
    try:
        os.makedirs(sys.argv[2],exist_ok=True)
        for dirname in os.listdir(sys.argv[1]):
            filename = sys.argv[1]+'/'+dirname

            f = open(filename,'rb')
            ln = os.path.getsize(filename); # length of file in bytes
            rem = ln%width 

            a = array.array("B") # uint8 array
            a.fromfile(f,ln-rem)
            f.close(); 

            g = numpy.reshape(a,(int(len(a)/width),width))
            g = numpy.uint8(g)
            
            im = Image.frombuffer('L', (width,int(len(a)/width)), g, 'raw', 'L', 0, 1)
            im.save(sys.argv[2] +'/'+dirname.split('.')[0] + '.png')
            sys.exit(0)
    except:
        print ('No folders found, checking for a single file')

    filename = sys.argv[1]

    f = open(filename,'rb')
    ln = os.path.getsize(filename); # length of file in bytes
    rem = ln%width 

    a = array.array("B") # uint8 array
    a.fromfile(f,ln-rem)
    f.close(); 

    g = numpy.reshape(a,(int(len(a)/width),width))
    g = numpy.uint8(g)
    
    im = Image.frombuffer('L', (width,int(len(a)/width)), g, 'raw', 'L', 0, 1)
    im.save(filename.split('.')[0] + '.png')
            